{% extends "base.html" %}

{% block title %}Ritual Log - Ritual Tracker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h1 class="mb-4">Ritual Log</h1>
        <p class="lead text-muted mb-4">
            Record your ritual practices in specific contexts and reflect on how they are reshaping your patterns over time.
        </p>

        <!-- Log New Ritual Form -->
        <div class="card mb-5 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">Log a New Ritual</h3>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('rituals') }}">
                    <!-- Ritual Selection -->
                    <div class="mb-3">
                        <label for="ritual_id" class="form-label">Select Ritual</label>
                        <select class="form-select" id="ritual_id" name="ritual_id" required>
                            <option value="">Choose a ritual...</option>
                            
                            <!-- Preset Rituals -->
                            {% set has_presets = available_rituals|selectattr('user_id', 'none')|list|length > 0 %}
                            {% if has_presets %}
                                <optgroup label="Preset Rituals">
                                    {% for ritual in available_rituals %}
                                        {% if ritual.user_id is none %}
                                            <option value="{{ ritual.id }}" 
                                                    data-description="{{ ritual.description }}"
                                                    data-source="{{ ritual.source }}">
                                                {{ ritual.name }}
                                                {% if ritual.virtue_category %}
                                                    ({{ ritual.virtue_category }})
                                                {% endif %}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                            
                            <!-- Custom Rituals -->
                            {% set has_custom = available_rituals|selectattr('user_id', 'defined')|list|length > 0 %}
                            {% if has_custom %}
                                <optgroup label="My Custom Rituals">
                                    {% for ritual in available_rituals %}
                                        {% if ritual.user_id is not none %}
                                            <option value="{{ ritual.id }}"
                                                    data-description="{{ ritual.description }}"
                                                    data-source="{{ ritual.source }}">
                                                {{ ritual.name }}
                                                {% if ritual.virtue_category %}
                                                    ({{ ritual.virtue_category }})
                                                {% endif %}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </optgroup>
                            {% endif %}
                        </select>
                        <div class="form-text">
                            Don't see your ritual? 
                            <a href="#" data-bs-toggle="modal" data-bs-target="#createRitualModal">Create a custom ritual</a>
                        </div>
                    </div>
                    
                    <!-- Ritual Info Display -->
                    <div id="ritual_info" class="mb-3" style="display: none;">
                        <div class="card bg-light">
                            <div class="card-body">
                                <p class="mb-1" id="ritual_description"></p>
                                <p class="mb-0 small text-muted" id="ritual_source"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Context Selection -->
                    <div class="mb-3">
                        <label for="context" class="form-label">Context</label>
                        <select class="form-select" id="context" name="context" required>
                            <option value="">Choose context...</option>
                            <option value="family">Family</option>
                            <option value="teacher">Teacher</option>
                            <option value="classmate">Classmate</option>
                            <option value="friend">Friend</option>
                            <option value="stranger">Stranger</option>
                            <option value="self">Self-Practice</option>
                            <option value="community">Community</option>
                        </select>
                    </div>

                    <!-- Reflection -->
                    <div class="mb-3">
                        <label for="reflection" class="form-label">Reflection</label>
                        <textarea class="form-control" id="reflection" name="reflection" rows="4" 
                                  placeholder="Describe the situation and reflect on your experience..." required></textarea>
                        <div class="form-text">
                            Consider: What was the situation and context? What familiar pattern did you notice? 
                            How did the ritual shift (or fail to shift) how you or others responded, and what did you learn?
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2 d-md-block">
                        <button type="submit" class="btn btn-primary">
                            Log Ritual
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Existing Ritual Entries -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h3 class="mb-0">Your Ritual Entries</h3>
            </div>
            <div class="card-body">
                {% if ritual_entries %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Ritual</th>
                                    <th>Context</th>
                                    <th>Reflection</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in ritual_entries %}
                                    <tr>
                                        <td class="text-nowrap">
                                            {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}
                                        </td>
                                        <td>
                                            <strong>{{ entry.ritual_name }}</strong>
                                            {% if entry.ritual %}
                                                <br>
                                                {% if entry.ritual.primary_category %}
                                                    <span class="badge bg-primary">{{ entry.ritual.primary_category }}</span>
                                                    {% if entry.ritual.secondary_category %}
                                                        <span class="badge bg-info">{{ entry.ritual.secondary_category }}</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ entry.context }}</span>
                                        </td>
                                        <td>
                                            {{ entry.reflection[:100] }}{% if entry.reflection|length > 100 %}...{% endif %}
                                        </td>
                                        <td class="text-nowrap">
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    data-bs-toggle="modal" data-bs-target="#editLogModal{{ entry.id }}">
                                                Edit
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    data-bs-toggle="modal" data-bs-target="#deleteModal{{ entry.id }}">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination Controls -->
                    {% if pagination.pages > 1 %}
                        <nav aria-label="Ritual log pagination" class="mt-3">
                            <ul class="pagination justify-content-center mb-0">
                                <!-- Previous -->
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('rituals', page=pagination.prev_num) if pagination.has_prev else '#' }}">
                                        &laquo; Previous
                                    </a>
                                </li>
                                
                                <!-- Page Numbers -->
                                {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                                    {% if p %}
                                        <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                            <a class="page-link" href="{{ url_for('rituals', page=p) }}">{{ p }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                
                                <!-- Next -->
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('rituals', page=pagination.next_num) if pagination.has_next else '#' }}">
                                        Next &raquo;
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        <p class="text-center text-muted small mt-2">
                            Page {{ pagination.page }} of {{ pagination.pages }} ({{ pagination.total }} entries)
                        </p>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info">
                        <p class="mb-0">
                            <strong>No ritual entries yet.</strong> Start your journey by logging your first ritual above!
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block modals %}
<!-- Create Custom Ritual Modal -->
<div class="modal fade" id="createRitualModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Create Custom Ritual</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_ritual') }}">
                <input type="hidden" name="redirect_to" value="rituals">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="create_name" class="form-label">Ritual Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="create_name" name="name" 
                               placeholder="e.g., Family dinner ritual" required>
                    </div>
                    <div class="mb-3">
                        <label for="create_description" class="form-label">Description</label>
                        <textarea class="form-control" id="create_description" name="description" rows="2"
                                  placeholder="What does this ritual involve?"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="create_primary" class="form-label">Primary Virtue</label>
                            <select class="form-select" id="create_primary" name="primary_category">
                                <option value="">-- None --</option>
                                <option value="Ren">仁 Ren - Benevolence</option>
                                <option value="Yi">义 Yi - Righteousness</option>
                                <option value="Li">礼 Li - Propriety</option>
                                <option value="Zhi">智 Zhi - Wisdom</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="create_secondary" class="form-label">Secondary Virtue</label>
                            <select class="form-select" id="create_secondary" name="secondary_category">
                                <option value="">-- None --</option>
                                <option value="Ren">仁 Ren - Benevolence</option>
                                <option value="Yi">义 Yi - Righteousness</option>
                                <option value="Li">礼 Li - Propriety</option>
                                <option value="Zhi">智 Zhi - Wisdom</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="create_source" class="form-label">Source</label>
                        <input type="text" class="form-control" id="create_source" name="source"
                               placeholder="e.g., Family tradition, Personal practice">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Ritual</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Log Entry Modals -->
{% for entry in ritual_entries %}
    <div class="modal fade" id="editLogModal{{ entry.id }}" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Edit Ritual Log</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{{ url_for('edit_log_entry', entry_id=entry.id) }}">
                    <div class="modal-body">
                        <div class="alert alert-info py-2 mb-3">
                            <small><strong>Logged:</strong> {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <div class="mb-3">
                            <label for="edit_ritual_{{ entry.id }}" class="form-label">Ritual</label>
                            <select class="form-select" id="edit_ritual_{{ entry.id }}" name="ritual_id" required>
                                {% for ritual in available_rituals %}
                                    <option value="{{ ritual.id }}" {% if entry.ritual_id == ritual.id %}selected{% endif %}>
                                        {{ ritual.name }}
                                        {% if ritual.is_preset %}(Preset){% else %}(Custom){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_context_{{ entry.id }}" class="form-label">Context</label>
                            <select class="form-select" id="edit_context_{{ entry.id }}" name="context" required>
                                <option value="family" {% if entry.context == 'family' %}selected{% endif %}>Family</option>
                                <option value="teacher" {% if entry.context == 'teacher' %}selected{% endif %}>Teacher</option>
                                <option value="classmate" {% if entry.context == 'classmate' %}selected{% endif %}>Classmate</option>
                                <option value="friend" {% if entry.context == 'friend' %}selected{% endif %}>Friend</option>
                                <option value="stranger" {% if entry.context == 'stranger' %}selected{% endif %}>Stranger</option>
                                <option value="self" {% if entry.context == 'self' %}selected{% endif %}>Self-Practice</option>
                                <option value="community" {% if entry.context == 'community' %}selected{% endif %}>Community</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit_reflection_{{ entry.id }}" class="form-label">Reflection</label>
                            <textarea class="form-control" id="edit_reflection_{{ entry.id }}" name="reflection" 
                                      rows="4" required>{{ entry.reflection }}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endfor %}

<!-- Delete Confirmation Modals -->
{% for entry in ritual_entries %}
    <div class="modal fade" id="deleteModal{{ entry.id }}" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this ritual log entry?
                    <div class="mt-2 p-2 bg-light rounded">
                        <strong>{{ entry.ritual_name }}</strong> on {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="POST" action="{{ url_for('delete_log_entry', entry_id=entry.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
{% endblock %}

